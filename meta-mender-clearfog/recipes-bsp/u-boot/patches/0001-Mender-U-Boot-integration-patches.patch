From 2206dc3a364676bb388ee4d8351a00059aefce4c Mon Sep 17 00:00:00 2001
From: Wayne Adams <wadams@davey.com.au>
Date: Tue, 22 Oct 2019 07:51:47 +1100
Subject: [PATCH] Mender U-Boot integration patches.

---
 configs/clearfog_defconfig      | 7 ++++++-
 include/config_defaults.h       | 7 +++++++
 include/config_distro_bootcmd.h | 1 -
 include/configs/clearfog.h      | 3 ---
 4 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/configs/clearfog_defconfig b/configs/clearfog_defconfig
index e1c5a1fa13..c8d081cf9d 100644
--- a/configs/clearfog_defconfig
+++ b/configs/clearfog_defconfig
@@ -36,7 +36,6 @@ CONFIG_CMD_CACHE=y
 CONFIG_CMD_TIME=y
 # CONFIG_SPL_PARTITION_UUIDS is not set
 CONFIG_DEFAULT_DEVICE_TREE="armada-388-clearfog"
-CONFIG_ENV_IS_IN_MMC=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_SPL_OF_TRANSLATE=y
 CONFIG_SCSI_AHCI=y
@@ -63,3 +62,9 @@ CONFIG_KIRKWOOD_SPI=y
 CONFIG_USB=y
 CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
+CONFIG_MMC=y
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_CMD_EXT4=y
+CONFIG_CMD_FS_GENERIC=y
+CONFIG_BOOTCOUNT_LIMIT=y
+CONFIG_BOOTCOUNT_ENV=y
\ No newline at end of file
diff --git a/include/config_defaults.h b/include/config_defaults.h
index 7ef928bbe1..f0fd637f49 100644
--- a/include/config_defaults.h
+++ b/include/config_defaults.h
@@ -20,3 +20,10 @@
 #define CONFIG_ZLIB 1
 
 #endif
+
+/* Mender Integration */
+#define CONFIG_ENV_SIZE 0x20000
+#define CONFIG_ENV_OFFSET 0x800000
+#define CONFIG_ENV_OFFSET_REDUND 0x1000000
+#define CONFIG_SYS_MMC_ENV_DEV 0
+#define CONFIG_SYS_MMC_ENV_PART 0
\ No newline at end of file
diff --git a/include/config_distro_bootcmd.h b/include/config_distro_bootcmd.h
index 555efb7433..3fac7560b8 100644
--- a/include/config_distro_bootcmd.h
+++ b/include/config_distro_bootcmd.h
@@ -428,7 +428,6 @@
 		"done\0"
 
 #ifndef CONFIG_BOOTCOMMAND
-#define CONFIG_BOOTCOMMAND "run distro_bootcmd"
 #endif
 
 #endif  /* _CONFIG_CMD_DISTRO_BOOTCMD_H */
diff --git a/include/configs/clearfog.h b/include/configs/clearfog.h
index 77ab6caf52..7b20df4bb2 100644
--- a/include/configs/clearfog.h
+++ b/include/configs/clearfog.h
@@ -39,16 +39,13 @@
 #define CONFIG_ENV_MIN_ENTRIES		128
 
 /* Environment in MMC */
-#define CONFIG_SYS_MMC_ENV_DEV		0
 #define CONFIG_ENV_SECT_SIZE		0x200
-#define CONFIG_ENV_SIZE			0x10000
 /*
  * For SD - reserve 1 LBA for MBR + 1M for u-boot image. The MMC/eMMC
  * boot image starts @ LBA-0.
  * As result in MMC/eMMC case it will be a 1 sector gap between u-boot
  * image and environment
  */
-#define CONFIG_ENV_OFFSET		0xf0000
 #define CONFIG_ENV_ADDR			CONFIG_ENV_OFFSET
 
 #define PHY_ANEG_TIMEOUT	8000	/* PHY needs a longer aneg time */
-- 
2.23.0.windows.1

